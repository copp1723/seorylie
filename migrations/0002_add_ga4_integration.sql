-- Migration: Add GA4 Integration Tables\n-- Description: Creates tables for centralized GA4 service account management\n-- Date: 2025-06-10\n\n-- GA4 Properties table - maps tenants to their GA4 properties\nCREATE TABLE IF NOT EXISTS \"ga4_properties\" (\n\t\"id\" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n\t\"tenant_id\" uuid NOT NULL,\n\t\"property_id\" text NOT NULL,\n\t\"property_name\" text NOT NULL,\n\t\"website_url\" text,\n\t\"is_active\" boolean DEFAULT true,\n\t\"access_granted_at\" timestamp,\n\t\"last_sync_at\" timestamp,\n\t\"sync_status\" text DEFAULT 'pending',\n\t\"metadata\" jsonb,\n\t\"created_at\" timestamp DEFAULT now(),\n\t\"updated_at\" timestamp DEFAULT now()\n);\n\n-- GA4 Service Account Credentials - centralized credential storage\nCREATE TABLE IF NOT EXISTS \"ga4_service_account\" (\n\t\"id\" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n\t\"environment\" text DEFAULT 'production' NOT NULL,\n\t\"service_account_email\" text NOT NULL,\n\t\"project_id\" text NOT NULL,\n\t\"private_key_encrypted\" text NOT NULL,\n\t\"key_id\" text NOT NULL,\n\t\"quota_limits\" jsonb,\n\t\"status\" text DEFAULT 'active',\n\t\"created_at\" timestamp DEFAULT now(),\n\t\"updated_at\" timestamp DEFAULT now(),\n\t\"expires_at\" timestamp\n);\n\n-- GA4 Report Cache - store generated reports to reduce API calls\nCREATE TABLE IF NOT EXISTS \"ga4_report_cache\" (\n\t\"id\" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n\t\"tenant_id\" uuid NOT NULL,\n\t\"property_id\" text NOT NULL,\n\t\"report_type\" text NOT NULL,\n\t\"date_range\" jsonb NOT NULL,\n\t\"report_data\" jsonb NOT NULL,\n\t\"generated_at\" timestamp DEFAULT now(),\n\t\"expires_at\" timestamp NOT NULL,\n\t\"cache_key\" text NOT NULL UNIQUE\n);\n\n-- GA4 API Usage Tracking - monitor quota usage\nCREATE TABLE IF NOT EXISTS \"ga4_api_usage\" (\n\t\"id\" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,\n\t\"tenant_id\" uuid,\n\t\"property_id\" text,\n\t\"endpoint\" text NOT NULL,\n\t\"request_count\" integer DEFAULT 1,\n\t\"quota_consumed\" integer DEFAULT 1,\n\t\"response_time\" integer,\n\t\"success\" boolean DEFAULT true,\n\t\"error_message\" text,\n\t\"request_date\" timestamp DEFAULT now(),\n\t\"hour\" text NOT NULL,\n\t\"day\" text NOT NULL\n);\n\n-- Add foreign key constraints\nALTER TABLE \"ga4_properties\" ADD CONSTRAINT \"ga4_properties_tenant_id_tenants_id_fk\" FOREIGN KEY (\"tenant_id\") REFERENCES \"tenants\"(\"id\") ON DELETE no action ON UPDATE no action;\nALTER TABLE \"ga4_report_cache\" ADD CONSTRAINT \"ga4_report_cache_tenant_id_tenants_id_fk\" FOREIGN KEY (\"tenant_id\") REFERENCES \"tenants\"(\"id\") ON DELETE no action ON UPDATE no action;\nALTER TABLE \"ga4_api_usage\" ADD CONSTRAINT \"ga4_api_usage_tenant_id_tenants_id_fk\" FOREIGN KEY (\"tenant_id\") REFERENCES \"tenants\"(\"id\") ON DELETE no action ON UPDATE no action;\n\n-- Create indexes for performance\nCREATE INDEX IF NOT EXISTS \"ga4_properties_tenant_idx\" ON \"ga4_properties\" (\"tenant_id\");\nCREATE INDEX IF NOT EXISTS \"ga4_properties_property_idx\" ON \"ga4_properties\" (\"property_id\");\nCREATE INDEX IF NOT EXISTS \"ga4_properties_status_idx\" ON \"ga4_properties\" (\"sync_status\");\n\nCREATE INDEX IF NOT EXISTS \"ga4_cache_tenant_idx\" ON \"ga4_report_cache\" (\"tenant_id\");\nCREATE INDEX IF NOT EXISTS \"ga4_cache_key_idx\" ON \"ga4_report_cache\" (\"cache_key\");\nCREATE INDEX IF NOT EXISTS \"ga4_cache_expires_idx\" ON \"ga4_report_cache\" (\"expires_at\");\n\nCREATE INDEX IF NOT EXISTS \"ga4_usage_tenant_day_idx\" ON \"ga4_api_usage\" (\"tenant_id\", \"day\");\nCREATE INDEX IF NOT EXISTS \"ga4_usage_hour_idx\" ON \"ga4_api_usage\" (\"hour\");\nCREATE INDEX IF NOT EXISTS \"ga4_usage_day_idx\" ON \"ga4_api_usage\" (\"day\");\n\n-- Add comments for documentation\nCOMMENT ON TABLE \"ga4_properties\" IS 'Maps tenants to their GA4 properties for centralized access management';\nCOMMENT ON TABLE \"ga4_service_account\" IS 'Stores encrypted service account credentials for GA4 API access';\nCOMMENT ON TABLE \"ga4_report_cache\" IS 'Caches generated GA4 reports to reduce API calls and improve performance';\nCOMMENT ON TABLE \"ga4_api_usage\" IS 'Tracks GA4 API usage for quota monitoring and rate limiting';\n\nCOMMENT ON COLUMN \"ga4_properties\".\"sync_status\" IS 'Status of property sync: pending, active, error, revoked';\nCOMMENT ON COLUMN \"ga4_service_account\".\"private_key_encrypted\" IS 'Encrypted private key using AES-256-GCM encryption';\nCOMMENT ON COLUMN \"ga4_report_cache\".\"cache_key\" IS 'Unique cache key generated from property, report type, and date range';\nCOMMENT ON COLUMN \"ga4_api_usage\".\"hour\" IS 'Hour identifier in YYYY-MM-DD-HH format for hourly quota tracking';\nCOMMENT ON COLUMN \"ga4_api_usage\".\"day\" IS 'Day identifier in YYYY-MM-DD format for daily quota tracking';